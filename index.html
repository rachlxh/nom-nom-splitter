<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nom-Nom Splitter</title>

  <!-- Mobile friendly -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --accent: #6366f1;
      --accent-soft: #eef2ff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at top left, #e0f2fe, #eef2ff 30%, #f9fafb 70%);
      color: var(--text-main);
    }

    /* Layout */
    .layout {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    .panel {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 12px 18px -5px rgba(15,23,42,0.1);
    }

    h1 {
      font-size: 26px;
      margin-bottom: 6px;
      margin-top: 0;
    }

    h2 {
      font-size: 18px;
      margin-top: 18px;
      margin-bottom: 6px;
    }

    .title-sub {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    .badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
      float: right;
      margin-top: -40px;
    }

    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #f9fafb;
      transition: 0.15s;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(99,102,241,0.3);
      background: #ffffff;
    }

    label {
      display: block;
      margin-top: 8px;
      font-size: 13px;
    }

    small.helper {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .checkbox-row {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .three-col {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
      margin-bottom: 8px;
    }

    @media (max-width: 700px) {
      .three-col { grid-template-columns: 1fr; }
    }

    .person-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
    }

    .remove-btn {
      background: #fee2e2;
      color: var(--danger);
      border: none;
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    .primary-btn {
      margin-top: 10px;
      padding: 10px;
      width: 100%;
      border: none;
      border-radius: 10px;
      background: var(--accent);
      color: white;
      font-size: 15px;
      cursor: pointer;
      transition: 0.2s;
    }

    .primary-btn:hover { background: #4f46e5; }

    .secondary-btn {
      padding: 8px 14px;
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fafb;
      cursor: pointer;
      font-size: 13px;
    }

    .secondary-btn:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    /* Sticky calculate on mobile */
    .sticky-calc {
      margin-top: 14px;
    }

    @media (max-width: 700px) {
      .sticky-calc {
        position: sticky;
        bottom: 0;
        padding-top: 8px;
        padding-bottom: 8px;
        background: linear-gradient(to top, rgba(255,255,255,0.98), rgba(255,255,255,0.88));
        z-index: 20;
      }
    }

    /* Summary styles */
    .summary-box {
      border-top: 1px dashed var(--border);
      padding-top: 14px;
      margin-top: 10px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .summary-row.grand {
      background: var(--accent-soft);
      padding: 6px 10px;
      border-radius: 10px;
      margin-top: 8px;
    }

    .pill-total {
      padding: 3px 10px;
      border-radius: 999px;
      background: #4f46e5;
      color: #ffffff;
      font-weight: 600;
    }

    .title-summary-display {
      margin-top: 16px;
      font-size: 16px;
      font-weight: 600;
      color: #4f46e5;
    }

    /* Table */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-top: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 520px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #f1f5f9;
      text-align: left;
    }

    th {
      background: #f9fafb;
      font-weight: 600;
    }

    td strong { color: var(--accent); }

    /* Suggestions dropdown */
    .suggestion-box {
      border: 1px solid var(--border);
      background: #ffffff;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 12px rgba(15,23,42,0.12);
      max-height: 180px;
      overflow-y: auto;
    }

    .suggestion-item {
      padding: 8px 10px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .suggestion-item span.count {
      font-size: 11px;
      color: var(--text-muted);
    }

    .suggestion-item:hover {
      background: #eef2ff;
      color: var(--accent);
    }

    /* Bill history */
    .history-empty {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .history-list {
      margin-top: 10px;
      border-top: 1px dashed var(--border);
      padding-top: 10px;
    }

    .history-item {
      width: 100%;
      text-align: left;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 6px;
    }

    .history-item:hover {
      background: #eef2ff;
      border-color: var(--accent);
    }

    .history-title {
      font-weight: 600;
    }

    .history-meta {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
    }

    /* Mobile tweaks */
    @media (max-width: 600px) {
      body {
        padding: 12px;
      }

      .panel {
        padding: 16px;
        border-radius: 14px;
      }

      h1 {
        font-size: 22px;
      }

      .title-sub {
        font-size: 13px;
      }

      .badge {
        float: none;
        margin-top: 8px;
        display: inline-block;
      }

      table {
        font-size: 12px;
      }
    }
  </style>
</head>

<body>
  <div class="layout">

    <!-- LEFT PANEL -->
    <div class="panel">
      <h1>Nom-Nom Splitter üçΩÔ∏è</h1>
      <div class="title-sub">Enter payees + charges. Summary appears on the right.</div>
      <div class="badge">by Raa ü¶ñ</div>

      <!-- Bill title -->
      <h2>üìã Bill Title</h2>
      <input id="billTitle" type="text" placeholder="e.g. GoNoodle, HaiDiLao, Team Lunch" />

      <!-- Bill settings -->
      <h2>‚öôÔ∏è Bill Settings</h2>

      <div class="three-col">
        <div>
          <label>‚úÇÔ∏è Staff Discount (%)</label>
          <input id="staffPct" type="number" step="0.01" value="10" />
          <div class="checkbox-row">
            <input id="applyStaff" type="checkbox" checked /> Apply
          </div>
        </div>

        <div>
          <label>üßæ Service Charge (%)</label>
          <input id="svcPct" type="number" step="0.01" value="10" />
          <div class="checkbox-row">
            <input id="applySvc" type="checkbox" checked /> Apply
          </div>
        </div>

        <div>
          <label>üí∞ GST (%)</label>
          <input id="gstPct" type="number" step="0.01" value="9" />
          <div class="checkbox-row">
            <input id="applyGst" type="checkbox" checked /> Apply
          </div>
        </div>
      </div>

      <!-- Common charge -->
      <h2>üîÅ Common Charge</h2>
      <label>Shared amount (split equally)</label>
      <input id="commonCharge" type="number" step="0.01" placeholder="e.g. 20 for shared dish" />
      <small class="helper">This amount will be divided equally across all payees and included in their base.</small>

      <!-- Payees -->
      <h2>üë• Payees</h2>
      <div id="peopleContainer"></div>

      <button class="secondary-btn" onclick="addPerson()">+ Add Person</button>

      <div class="sticky-calc">
        <button class="primary-btn" onclick="calculate()">Calculate</button>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="panel">
      <h2>üìä Summary</h2>

      <div id="summaryTotals" class="summary-box"></div>

      <div id="summaryTitle" class="title-summary-display"></div>

      <div id="perPersonTable"></div>

      <h2>üßæ Bill History</h2>
      <div id="billHistory"></div>
    </div>
  </div>

  <script>
    /* ---------- Payee history helpers (frequency, most used first) ---------- */

    function loadPayeeHistory() {
      try {
        return JSON.parse(localStorage.getItem("payeeHistoryV2") || "[]");
      } catch {
        return [];
      }
    }

    function savePayeeHistory(history) {
      localStorage.setItem("payeeHistoryV2", JSON.stringify(history));
    }

    function savePayeeName(name) {
      name = (name || "").trim();
      if (!name) return;

      let history = loadPayeeHistory();
      const lower = name.toLowerCase();
      let existing = history.find(h => h.name.toLowerCase() === lower);

      if (existing) {
        existing.count += 1;
        existing.name = name;
      } else {
        history.push({ name, count: 1 });
      }

      history.sort((a, b) => b.count - a.count);
      if (history.length > 30) history = history.slice(0, 30);

      savePayeeHistory(history);
    }

    function clearSuggestions() {
      document.querySelectorAll(".suggestion-box").forEach(b => b.remove());
    }

    function showSuggestions(inputEl) {
      clearSuggestions();
      const history = loadPayeeHistory();
      if (!history.length) return;

      const query = (inputEl.value || "").trim().toLowerCase();
      let list = history;

      if (query) {
        const filtered = history.filter(h =>
          h.name.toLowerCase().includes(query)
        );
        if (filtered.length) list = filtered;
      }

      const box = document.createElement("div");
      box.className = "suggestion-box";

      list.forEach(h => {
        const item = document.createElement("div");
        item.className = "suggestion-item";
        item.innerHTML = `<span>${h.name}</span><span class="count">√ó${h.count}</span>`;
        item.onclick = (e) => {
          e.stopPropagation();
          inputEl.value = h.name;
          savePayeeName(h.name);
          clearSuggestions();
        };
        box.appendChild(item);
      });

      inputEl.parentElement.appendChild(box);
    }

    document.addEventListener("click", (e) => {
      if (!e.target.classList.contains("name-input") &&
          !e.target.closest(".suggestion-box")) {
        clearSuggestions();
      }
    });

    /* ---------- Bill state + history ---------- */

    function saveCurrentState(state) {
      localStorage.setItem("billStateV1", JSON.stringify(state));
    }

    function loadCurrentState() {
      try {
        const raw = localStorage.getItem("billStateV1");
        if (!raw) return null;
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function loadBillHistoryList() {
      try {
        return JSON.parse(localStorage.getItem("billHistoryV1") || "[]");
      } catch {
        return [];
      }
    }

    function saveBillHistoryList(list) {
      localStorage.setItem("billHistoryV1", JSON.stringify(list));
    }

    function addBillToHistory(entry) {
      let history = loadBillHistoryList();
      history.unshift(entry);
      if (history.length > 20) history = history.slice(0, 20);
      saveBillHistoryList(history);
      renderBillHistory();
    }

    function renderBillHistory() {
      const container = document.getElementById("billHistory");
      const history = loadBillHistoryList();

      if (!history.length) {
        container.innerHTML = `<p class="history-empty">No past bills yet. Calculate to save your first bill.</p>`;
        return;
      }

      let html = `<div class="history-list">`;
      history.forEach((bill, idx) => {
        const title = bill.billTitle || "Untitled bill";
        const dt = new Date(bill.timestamp || Date.now());
        const dateStr = dt.toLocaleDateString(undefined, { month: "short", day: "numeric" });
        const timeStr = dt.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
        html += `
          <button class="history-item" onclick="loadBillFromHistory(${idx})">
            <div class="history-title">${title}</div>
            <div class="history-meta">
              <span>${dateStr} ¬∑ ${timeStr}</span>
              <span>Total $${(bill.grandTotal || 0).toFixed(2)}</span>
            </div>
          </button>
        `;
      });
      html += `</div>`;
      container.innerHTML = html;
    }

    function loadBillFromHistory(index) {
      const history = loadBillHistoryList();
      const bill = history[index];
      if (!bill) return;

      document.getElementById("billTitle").value = bill.billTitle || "";
      document.getElementById("staffPct").value = bill.staffPct ?? 10;
      document.getElementById("svcPct").value   = bill.svcPct   ?? 10;
      document.getElementById("gstPct").value   = bill.gstPct   ?? 9;
      document.getElementById("applyStaff").checked = !!bill.applyStaff;
      document.getElementById("applySvc").checked   = !!bill.applySvc;
      document.getElementById("applyGst").checked   = !!bill.applyGst;
      document.getElementById("commonCharge").value = bill.commonCharge ?? 0;

      const container = document.getElementById("peopleContainer");
      container.innerHTML = "";
      (bill.people || []).forEach(p => addPerson(p.name, p.amt));

      calculate();
    }

    /* ---------- Core UI logic ---------- */

    function addPerson(name = "", amount = "") {
      const row = document.createElement("div");
      row.className = "person-row";
      row.innerHTML = `
        <div>
          <input type="text"
                 class="name-input"
                 placeholder="Name"
                 value="${name}"
                 onfocus="showSuggestions(this)"
                 oninput="showSuggestions(this)"
                 onblur="savePayeeName(this.value)">
        </div>
        <input type="number" class="amount-input" placeholder="Base amount" step="0.01" value="${amount}">
        <button class="remove-btn" onclick="this.parentElement.remove()">‚úï</button>
      `;
      document.getElementById("peopleContainer").appendChild(row);
    }

    function calculate() {
      const billTitle = document.getElementById("billTitle").value;

      const staffPct = +document.getElementById("staffPct").value || 0;
      const svcPct   = +document.getElementById("svcPct").value   || 0;
      const gstPct   = +document.getElementById("gstPct").value   || 0;
      const commonCharge = +document.getElementById("commonCharge").value || 0;

      const applyStaff = document.getElementById("applyStaff").checked;
      const applySvc   = document.getElementById("applySvc").checked;
      const applyGst   = document.getElementById("applyGst").checked;

      const staffRate = applyStaff ? staffPct / 100 : 0;
      const svcRate   = applySvc   ? svcPct / 100   : 0;
      const gstRate   = applyGst   ? gstPct / 100   : 0;

      const rows = document.querySelectorAll(".person-row");
      const people = [];
      let baseItemsTotal = 0;

      rows.forEach((row, i) => {
        const nameEl = row.querySelector(".name-input");
        const amtEl  = row.querySelector(".amount-input");
        const name = (nameEl.value || "").trim() || `Person ${i + 1}`;
        const amt = parseFloat(amtEl.value) || 0;

        people.push({ name, amt });
        baseItemsTotal += amt;

        savePayeeName(name);
      });

      if (people.length === 0 || (baseItemsTotal <= 0 && commonCharge <= 0)) {
        alert("Please enter some amounts or a common charge.");
        return;
      }

      const baseTotal = baseItemsTotal + commonCharge;
      const totalAfterStaff = baseTotal * (1 - staffRate);
      const svcTotal = totalAfterStaff * svcRate;
      const gstTotal = (totalAfterStaff + svcTotal) * gstRate;
      const grandTotal = totalAfterStaff + svcTotal + gstTotal;

      // Summary
      let summaryHtml = "";
      if (commonCharge > 0) {
        summaryHtml += `
          <div class="summary-row"><span>Items subtotal</span> <strong>$${baseItemsTotal.toFixed(2)}</strong></div>
          <div class="summary-row"><span>Common charge (shared)</span> <strong>$${commonCharge.toFixed(2)}</strong></div>
          <div class="summary-row"><span>Base total (before discount)</span> <strong>$${baseTotal.toFixed(2)}</strong></div>
        `;
      } else {
        summaryHtml += `
          <div class="summary-row"><span>Base total</span> <strong>$${baseTotal.toFixed(2)}</strong></div>
        `;
      }

      summaryHtml += `
        <div class="summary-row"><span>After staff discount</span> <strong>$${totalAfterStaff.toFixed(2)}</strong></div>
        <div class="summary-row"><span>Service charge</span> <strong>$${svcTotal.toFixed(2)}</strong></div>
        <div class="summary-row"><span>GST</span> <strong>$${gstTotal.toFixed(2)}</strong></div>
        <div class="summary-row grand"><span>Grand total</span> <span class="pill-total">$${grandTotal.toFixed(2)}</span></div>
      `;

      document.getElementById("summaryTotals").innerHTML = summaryHtml;
      document.getElementById("summaryTitle").textContent = billTitle || "";

      const staffLabel = `After Staff (${staffPct}%)`;

      // Per-person breakdown
      let tableHTML = `
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Base (incl. common)</th>
                <th>${staffLabel}</th>
                <th>After Svc</th>
                <th>After GST</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
      `;

      const perCommon = people.length ? commonCharge / people.length : 0;

      people.forEach(p => {
        const baseWithCommon = p.amt + perCommon;
        const share = baseWithCommon / baseTotal;

        const afterStaff = baseWithCommon * (1 - staffRate);
        const svcShare = svcTotal * share;
        const afterSvc = afterStaff + svcShare;
        const gstShare = gstTotal * share;
        const afterGst = afterSvc + gstShare;

        tableHTML += `
          <tr>
            <td>${p.name}</td>
            <td>$${baseWithCommon.toFixed(2)}</td>
            <td>$${afterStaff.toFixed(2)}</td>
            <td>$${afterSvc.toFixed(2)}</td>
            <td>$${afterGst.toFixed(2)}</td>
            <td><strong>$${afterGst.toFixed(2)}</strong></td>
          </tr>
        `;
      });

      tableHTML += `
            </tbody>
          </table>
        </div>
      `;
      document.getElementById("perPersonTable").innerHTML = tableHTML;

      // Save current state for reload
      const currentState = {
        billTitle,
        staffPct, svcPct, gstPct,
        applyStaff, applySvc, applyGst,
        commonCharge,
        people,
      };
      saveCurrentState(currentState);

      // Save to bill history
      addBillToHistory({
        ...currentState,
        grandTotal,
        timestamp: Date.now(),
      });

      // Scroll to summary (nice on mobile)
      document.getElementById("summaryTotals")
        .scrollIntoView({ behavior: "smooth" });
    }

    // Initialise on load
    (function init() {
      const saved = loadCurrentState();
      const container = document.getElementById("peopleContainer");

      if (saved && saved.people && saved.people.length) {
        document.getElementById("billTitle").value = saved.billTitle || "";
        document.getElementById("staffPct").value  = saved.staffPct ?? 10;
        document.getElementById("svcPct").value    = saved.svcPct   ?? 10;
        document.getElementById("gstPct").value    = saved.gstPct   ?? 9;
        document.getElementById("applyStaff").checked = !!saved.applyStaff;
        document.getElementById("applySvc").checked   = !!saved.applySvc;
        document.getElementById("applyGst").checked   = !!saved.applyGst;
        document.getElementById("commonCharge").value = saved.commonCharge ?? 0;

        container.innerHTML = "";
        saved.people.forEach(p => addPerson(p.name, p.amt));
      } else {
        addPerson("Payee 1");
        addPerson("Payee 2");
      }

      renderBillHistory();
    })();
  </script>
</body>
</html>
